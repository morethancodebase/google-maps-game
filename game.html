<!DOCTYPE html>
<html>
<head>
  <title>Street View Destination Game</title>
  <meta charset="utf-8">
  <style>
    body { margin: 0; display: flex; height: 100vh; }
    #street-view { flex: 2; position: relative; }
    #map { flex: 1; }
    #info {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
      font-family: Arial, sans-serif;
      z-index: 20;
    }
    /* Avatar overlay inside Street View */
    #avatar {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 50px;
      z-index: 15;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="street-view">
    <img id="avatar" src="https://img.icons8.com/emoji/96/person-walking.png" alt="player">
  </div>
  <div id="map"></div>
  <div id="info"></div>

  <script>
    // üîë Replace with your API key
    const API_KEY = "API_KEY";

    let map, panorama, playerMarker, destinationMarker;
    let destination = { lat: 40.7580, lng: -73.9855, name: "" }; // Example
    let startLocation;
    let timer = 300;
    let countdown;

    function initGame() {
      // pick a random starting point within ~500m of destination
      startLocation = randomNearbyLocation(destination, 500);

      // init minimap
      map = new google.maps.Map(document.getElementById("map"), {
        center: startLocation,
        zoom: 14,
      });

      // player marker with human icon üö∂
      playerMarker = new google.maps.Marker({
        position: startLocation,
        map: map,
        icon: {
          url: "https://img.icons8.com/emoji/48/person-walking.png",
          scaledSize: new google.maps.Size(40, 40)
        }
      });

      // destination marker
      destinationMarker = new google.maps.Marker({
        position: { lat: destination.lat, lng: destination.lng },
        map: map,
        label: "Goal",
      });

      // show info text
      document.getElementById("info").innerHTML =
        `‚è≥ Time left: <span id="timer">${timer}</span> sec`;

      // init street view at start location
      panorama = new google.maps.StreetViewPanorama(
        document.getElementById("street-view"),
        {
          position: startLocation,
          pov: { heading: 34, pitch: 10 },
          zoom: 1,
          motionTracking: false,
          motionTrackingControl: false,
        }
      );

      // sync street view location updates to marker
      panorama.addListener("position_changed", () => {
        const pos = panorama.getPosition();
        playerMarker.setPosition(pos);
        map.setCenter(pos);

        // check win condition (within 50m)
        const dist = haversineDistance(
          pos.lat(), pos.lng(),
          destination.lat, destination.lng
        );
        if (dist < 0.05) {
          clearInterval(countdown);
          alert("üéâ You reached " + destination.name + " with " + timer + " sec left!");
        }
      });

      // movement updates
      panorama.addListener("links_changed", () => {
        const pos = panorama.getPosition();
        playerMarker.setPosition(pos);
        map.setCenter(pos);
      });
      panorama.addListener("pov_changed", () => {
        const pos = panorama.getPosition();
        playerMarker.setPosition(pos);
      });

      map.setStreetView(panorama);

      // start countdown timer
      countdown = setInterval(() => {
        timer--;
        document.getElementById("timer").innerText = timer;
        if (timer <= 0) {
          clearInterval(countdown);
          alert("‚è≥ Time's up! You failed to reach " + destination.name);
        }
      }, 1000);
    }

    // helper: random point within radius (meters)
    function randomNearbyLocation(center, radius) {
      const y0 = center.lat;
      const x0 = center.lng;
      const rd = radius / 111300; // meters in one degree

      const u = Math.random();
      const v = Math.random();
      const w = rd * Math.sqrt(u);
      const t = 2 * Math.PI * v;
      const x = w * Math.cos(t);
      const y = w * Math.sin(t);

      return { lat: y0 + y, lng: x0 + x };
    }

    // helper: haversine distance in km
    function haversineDistance(lat1, lon1, lat2, lon2) {
      function toRad(x) { return x * Math.PI / 180; }
      const R = 6371; // km
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }
  </script>

  <script>
    // load Google Maps script dynamically with API_KEY
    function loadGoogleMaps() {
      const script = document.createElement("script");
      script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&callback=initGame`;
      script.async = true;
      document.head.appendChild(script);
    }

    loadGoogleMaps();
  </script>
</body>
</html>
